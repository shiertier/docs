# Firestore 企业版重大更新：引入管道操作与百余项新查询功能

## 文档信息
- 来源：https://www.infoq.cn/article/t9ORmgH3AUBsYygo04pd?utm_source=rss&utm_medium=article

## 摘要
**1) 一句话总结**
谷歌对 Firestore 企业版进行了重大升级，引入支持百余项新特性的管道（Pipeline）操作，并将索引改为可选配置，大幅提升了复杂数据处理能力与架构灵活性。

**2) 关键点**
*   **引入管道操作：** 允许串联多个查询阶段，在数据库内部直接处理数组解包、结果聚合、聚合后过滤及正则表达式匹配。
*   **百余项新特性：** 新查询引擎包含超过 100 个新特性，目前已在 Android、iOS、Web 和管理员 SDK 中提供预览版（Flutter、Unity 和 C++ 支持将后续推出）。
*   **索引机制重构：** 废除标准版默认自动创建单字段索引的机制，索引变为可选配置，支持稀疏、非稀疏和唯一索引，从而提升写入速度并降低存储成本。
*   **新增性能分析工具：** 引入 **Query Explain**（显示索引命中或全表扫描情况）和 **Query Insights**（显示高频查询及其性能模式），辅助开发者优化索引。
*   **计费模型优化：** 包含免费层；将写入和删除合并为单一的“写入操作”并按数据块计费，有效降低了小文档应用的成本。
*   **向后兼容性：** SDK 语法与标准版兼容，开发者可通过 `db.pipeline.createFrom(query)` 直接在现有查询上添加新阶段，无需重写代码。
*   **双版本并行：** 标准版不会被弃用，谷歌将继续支持两个版本。

**3) 风险/不足**
*   **性能权衡：** 放弃强制索引后，在大型未索引集合上运行查询会导致速度变慢；且预览期间整体性能可能会有所落后。
*   **迁移成本：** 从标准版迁移至企业版需手动导出/导入数据，且**索引和安全规则不会自动转移**，必须重新创建。
*   **预览版功能缺失：** 目前不兼容 Firestore 模拟器，不支持实时监听或离线持久性。
*   **特定查询限制：** 预览版不处理数组包含（array-contains）或向量搜索，在此类操作上效率暂不如标准版。
*   **版本混用错误：** 若在标准版数据库上运行管道（Pipeline）操作，系统会抛出服务器错误。

## 正文
谷歌对 Firestore 企业版的查询引擎进行了彻底改革，正式引入管道（Pipeline）操作。这一更新允许开发者将多个查询阶段串联起来，用于处理复杂的聚合、数组操作和正则表达式匹配。此次升级不仅消除了 Firestore 长期以来的查询限制，还将索引变为可选配置，使其在功能上与其他主流 NoSQL 平台（如 MongoDB）齐平。

### 管道操作的强大能力

Pipeline 操作通过数据库内部的顺序阶段来转换数据。开发者现在可以解包数组、聚合结果，并在聚合输出上进行过滤——这些能力在以前是无法实现的。

新引擎支持超过 100 个查询特性，目前已在 Android、iOS、Web 和管理员 SDK 的预览版中提供（Flutter、Unity 和 C++ 的支持将稍后推出）。

**应用示例：**
以一个食谱应用为例。过去，如果标签以数组形式存储在食谱文档中，开发者无法直接在查询中提取并计数以找出热门标签，只能额外维护一份标签元数据。现在借助 Pipeline 操作，只需一个查询即可完成：解包标签数组 -> 计算所有食谱中的出现次数 -> 按标签名称分组 -> 按流行度排序 -> 返回前十名。

### 索引机制的颠覆与性能优化

Firestore 企业版不再自动创建索引，也不强制要求依赖索引来运行查询。这颠覆了标准版默认构建单字段索引的模型。

*   **权衡优势：** 写入速度更快，存储成本降低；但在大型未索引集合上运行查询会变慢。
*   **性能分析工具：** 谷歌新增了 **Query Explain**（显示查询是命中了索引还是回退到全表扫描）和 **Query Insights**（显示最常运行的查询及其性能模式），帮助开发者精准决定哪里真正需要索引。
*   **兼容与支持：** 企业版支持稀疏、非稀疏和唯一索引。SDK 与标准版语法保持向后兼容，开发者只需将标准查询包装在 `db.pipeline.createFrom(query)` 中，即可立即添加新阶段，无需重写现有代码。

### 定价模型与迁移指南

尽管名为“企业版”，该版本依然包含一个**免费层**。

*   **计费变化：** 企业版将写入和删除合并为单一的“写入操作”类别，并按数据块计费。这对于小文档应用来说，能有效降低成本（标准版是将写入和删除分开计费的）。
*   **迁移方式：** 从标准版迁移到企业版，需要使用 Firestore 的导入/导出服务将数据复制到新数据库。需要注意的是，索引和安全规则不会自动转移，需要重新创建。在连接字符串更改之前，任何指向旧数据库的客户端将继续使用旧库。

### 架构影响与目标场景

谷歌强调，此次更新的目标用例主要针对**电子商务、互动游戏、内容管理和复杂的用户个性化**等高要求解决方案。标准版中对索引的强依赖通常需要开发者在应用生命周期中提前规划，而新引擎解决了这一痛点。

云架构师 Gustavo Olmedo 指出，随着应用增长，数据库常无意中成为数据处理层。Firestore 的新引擎明确了这一点，避免了团队在应用代码中处理复杂逻辑。他总结了三个关键的架构变化：

1.  **索引控制权转移：** 交给开发者，从而提高写入性能并减少存储开销。
2.  **可观测性提升：** 查询规划和执行统计成为一等公民。
3.  **成本更可预测：** 使用量定价与文档大小挂钩，而非隐含的索引行为。

此外，现有的 Firestore 用户可以逐步采用管道，甚至通过其 MongoDB 兼容模式重用工具。Olmedo 认为核心的架构思考在于：“将逻辑更接近数据是否简化了整个系统？”而不仅仅是数据库能否做更多。

### 预览版限制与标准版现状

目前 Pipeline 操作处于预览阶段，存在以下限制：
*   尚未与 Firestore 模拟器兼容。
*   不支持实时监听或离线持久性。
*   不处理数组包含（array-contains）或向量搜索，效率暂不如标准版。
*   预览期间性能可能会有所落后（谷歌表示将使用其他索引作为回退）。

**标准版不会消失。** 谷歌确认将继续支持两个版本，熟悉的查询方法也不会被弃用。如果在标准数据库上运行流水线操作，系统会抛出服务器错误。

*注：新的查询引擎作为 Firestore 企业版的一部分，已在原生模式下发布。完整的文档和代码示例可在 Firebase 的开发文档中找到。*

## 关联主题
- [[00-元语/data-pipeline]]
- [[00-元语/observability]]
- [[00-元语/sdk]]
- [[00-元语/serverless]]
