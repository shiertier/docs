name: Quartz Build And Deploy

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: quartz-pages-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Prepare Quartz Runtime
        run: bash scripts/prepare_quartz_site.sh

      - name: Install Quartz Dependencies
        working-directory: /tmp/quartz-runtime
        run: npm ci

      - name: Build Quartz
        working-directory: /tmp/quartz-runtime
        run: npx quartz build

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: /tmp/quartz-runtime/public

  deploy:
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Cancel Active Pages Deployments
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const activeStates = new Set(["in_progress", "pending", "queued", "building"])

            const listActive = async () => {
              const deployments = await github.paginate(github.rest.repos.listPagesDeployments, {
                owner,
                repo,
                per_page: 100,
              })
              return deployments.filter((deployment) => {
                const status = (deployment.status || "").toLowerCase()
                return activeStates.has(status)
              })
            }

            const activeNow = await listActive()
            if (activeNow.length === 0) {
              core.info("No active Pages deployments found.")
            }

            for (const deployment of activeNow) {
              core.info(`Cancel Pages deployment ${deployment.id} (${deployment.status})`)
              await github.request("POST /repos/{owner}/{repo}/pages/deployments/{deployment_id}/cancel", {
                owner,
                repo,
                deployment_id: deployment.id,
              })
            }

            for (let attempt = 1; attempt <= 24; attempt += 1) {
              const remaining = await listActive()
              if (remaining.length === 0) {
                core.info("All active Pages deployments cleared.")
                return
              }
              core.info(
                `Waiting for Pages queue to clear (${attempt}/24): ${remaining
                  .map((deployment) => `${deployment.id}:${deployment.status}`)
                  .join(", ")}`
              )
              await new Promise((resolve) => setTimeout(resolve, 5000))
            }

            core.setFailed("Timed out waiting for active Pages deployments to clear.")
      - name: Deploy To GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
