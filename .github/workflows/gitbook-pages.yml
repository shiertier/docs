name: Quartz Build And Deploy

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: quartz-pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Prepare Quartz Runtime
        run: bash scripts/prepare_quartz_site.sh

      - name: Install Quartz Dependencies
        working-directory: /tmp/quartz-runtime
        run: npm ci

      - name: Build Quartz
        working-directory: /tmp/quartz-runtime
        run: npx quartz build

      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: /tmp/quartz-runtime/public

  deploy:
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment_try_1.outputs.page_url || steps.deployment_try_2.outputs.page_url || steps.deployment.outputs.page_url }}
    steps:
      - name: Best-Effort Cancel Previous Pages Build
        if: github.event_name == 'push' && github.event.before != '' && github.event.before != '0000000000000000000000000000000000000000'
        continue-on-error: true
        run: |
          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pages/deployments/${{ github.event.before }}/cancel" \
            || true
      - name: Best-Effort Cancel Recent Pages Builds By SHA
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const branch = context.ref.replace("refs/heads/", "")
            const currentSha = context.sha
            const candidateShas = new Set()

            const runs = await github.paginate(github.rest.actions.listWorkflowRunsForRepo, {
              owner,
              repo,
              branch,
              per_page: 100,
            })

            for (const run of runs) {
              const sha = String(run.head_sha || "").trim()
              if (!sha || sha === currentSha) continue
              candidateShas.add(sha)
              if (candidateShas.size >= 20) break
            }

            for (const sha of candidateShas) {
              try {
                core.info(`Cancel Pages deployment by SHA: ${sha}`)
                await github.request(
                  "POST /repos/{owner}/{repo}/pages/deployments/{deployment_id}/cancel",
                  { owner, repo, deployment_id: sha }
                )
              } catch (error) {
                core.info(`Skip SHA ${sha}: ${error.message}`)
              }
            }
      - name: Cancel Active Pages Deployments
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner
            const repo = context.repo.repo
            const activeStates = new Set(["in_progress", "pending", "queued", "building"])
            const resolveDeploymentId = (deployment) => {
              return String(
                deployment?.page_build_version ||
                deployment?.pages_build_version ||
                deployment?.id ||
                ""
              ).trim()
            }

            const listActive = async () => {
              const deployments = await github.paginate(github.rest.repos.listPagesDeployments, {
                owner,
                repo,
                per_page: 100,
              })
              return deployments.filter((deployment) => {
                const status = (deployment.status || "").toLowerCase()
                return activeStates.has(status)
              })
            }

            const activeNow = await listActive()
            if (activeNow.length === 0) {
              core.info("No active Pages deployments found.")
            }

            for (const deployment of activeNow) {
              const deploymentId = resolveDeploymentId(deployment)
              if (!deploymentId) continue
              core.info(
                `Cancel Pages deployment ${deploymentId} ` +
                `(status=${deployment.status}, raw_id=${deployment.id})`
              )
              await github.request("POST /repos/{owner}/{repo}/pages/deployments/{deployment_id}/cancel", {
                owner,
                repo,
                deployment_id: deploymentId,
              })
            }

            for (let attempt = 1; attempt <= 24; attempt += 1) {
              const remaining = await listActive()
              if (remaining.length === 0) {
                core.info("All active Pages deployments cleared.")
                return
              }
              core.info(
                `Waiting for Pages queue to clear (${attempt}/24): ${remaining
                  .map((deployment) => `${deployment.id}:${deployment.status}`)
                  .join(", ")}`
              )
              await new Promise((resolve) => setTimeout(resolve, 5000))
            }

            core.setFailed("Timed out waiting for active Pages deployments to clear.")
      - name: Deploy To GitHub Pages (Attempt 1)
        id: deployment_try_1
        continue-on-error: true
        uses: actions/deploy-pages@v4

      - name: Wait Before Retry 2
        if: steps.deployment_try_1.outcome != 'success'
        run: sleep 20

      - name: Deploy To GitHub Pages (Attempt 2)
        if: steps.deployment_try_1.outcome != 'success'
        id: deployment_try_2
        continue-on-error: true
        uses: actions/deploy-pages@v4

      - name: Wait Before Final Retry
        if: steps.deployment_try_1.outcome != 'success' && steps.deployment_try_2.outcome != 'success'
        run: sleep 30

      - name: Deploy To GitHub Pages (Final Attempt)
        if: steps.deployment_try_1.outcome != 'success' && steps.deployment_try_2.outcome != 'success'
        id: deployment
        uses: actions/deploy-pages@v4
